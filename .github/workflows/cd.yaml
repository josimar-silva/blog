name: Continuous Delivery

on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types: [completed]
    branches: [main]

permissions:
  contents: read

jobs:
  fetch-version:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-24.04
    outputs:
      release_version: ${{ steps.get_version.outputs.VERSION }}
      is_release: ${{ steps.check_snapshot.outputs.RELEASE }}

    steps:
      - name: üõ°Ô∏è Harden the runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: üì¶ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: üá≥ Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "24.13.0"

      - name: üè∑Ô∏è Get package version
        id: get_version
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: üîç Check if version is SNAPSHOT
        id: check_snapshot
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          if [[ "$VERSION" == *"-SNAPSHOT"* ]]; then
            echo "RELEASE=false" >> $GITHUB_OUTPUT
          else
            echo "RELEASE=true" >> $GITHUB_OUTPUT
          fi
          echo "Release Version: $VERSION"

  release:
    needs: [fetch-version]
    if: ${{ github.event.workflow_run.conclusion == 'success' && needs.fetch-version.outputs.is_release == 'true' }}
    runs-on: ubuntu-24.04

    permissions:
      contents: write
      id-token: write
      attestations: write
      actions: read

    env:
      RELEASE_VERSION: ${{ needs.fetch-version.outputs.release_version }}

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: üá≥ Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: "24.13.0"

      - name: ‚¨áÔ∏è Download build artifact
        uses: dawidd6/action-download-artifact@5c98f0b039f36ef966fdb7dfa9779262785ecb05 # v14
        with:
          workflow: ci.yaml
          name: blog-${{ github.event.workflow_run.head_sha }}
          path: dist
          github_token: ${{ secrets.GITHUB_TOKEN }}
          run_id: ${{ github.event.workflow_run.id }}

      - name: üìù Add licenses
        run: |
          cp LICENSE-MIT dist/LICENSE-MIT
          cp LICENSE-CC-BY-NC dist/LICENSE-CC-BY-NC

      - name: üì¶ Create archive
        run: |
          tar -czvf blog-${{ env.RELEASE_VERSION }}.tar.gz -C dist .
          shasum -a 512 blog-${{ env.RELEASE_VERSION }}.tar.gz > blog-${{ env.RELEASE_VERSION }}.tar.gz.sha512

      - name: üìù Attest release provenance
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        with:
          subject-path: "${{ github.workspace }}/blog-${{ env.RELEASE_VERSION }}.tar.gz"

      - name: üõ†Ô∏è Setup git
        run: |
          git config --global user.name "radagastbot[bot]"
          git config --global user.email "radagastbot[bot]@users.noreply.github.com"

      - name: üîñ Create Git Tag
        run: |
          git tag "v${{ env.RELEASE_VERSION }}" "${{ github.event.workflow_run.head_sha }}"
          git push origin "v${{ env.RELEASE_VERSION }}"

      - name: üìù Generate changelog
        uses: orhun/git-cliff-action@e16f179f0be49ecdfe63753837f20b9531642772 # v4
        with:
          config: cliff.toml
          args: -v --latest --strip header
        env:
          OUTPUT: CHANGELOG.md
          GITHUB_REPO: ${{ github.repository }}

      - name: üöÄ Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: |
            blog-${{ env.RELEASE_VERSION }}.tar.gz
            blog-${{ env.RELEASE_VERSION }}.tar.gz.sha512
          tag_name: v${{ env.RELEASE_VERSION }}
          name: Release v${{ env.RELEASE_VERSION }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: true

      - name: üî¢ Generate next package Version
        run: |
          MAJOR=$(echo ${{ env.RELEASE_VERSION }} | cut -d. -f1)
          MINOR=$(echo ${{ env.RELEASE_VERSION }} | cut -d. -f2)
          PATCH=$(echo ${{ env.RELEASE_VERSION }} | cut -d. -f3)
          PATCH=$((PATCH + 1))
          NEXT_PACKAGE_VERSION="$MAJOR.$MINOR.$PATCH-SNAPSHOT"
          echo "Next Version will be: ${NEXT_PACKAGE_VERSION}"
          echo "NEXT_PACKAGE_VERSION=${NEXT_PACKAGE_VERSION}" >> $GITHUB_ENV

      - name: ‚¨ÜÔ∏è Increment package version
        run: npm version ${{ env.NEXT_PACKAGE_VERSION }} --no-git-tag-version

      - name: üì§ Push new package version to repo
        run: |
          git config user.name "radagastbot[bot]"
          git config user.email "radagastbot[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          git commit -m "chore(release): set next SNAPSHOT version"
          git push
